# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1h2wE2QAPM4DQlIYyC7Zbs4SNU_uCACgX
"""


import streamlit as st
import tensorflow as tf
from PIL import Image
import numpy as np
import io

# --- Configuration and Constants ---
MODEL_PATH = '/content/drive/MyDrive/Colab Notebooks/panda/brain_tumor_model.h5'
IMG_WIDTH = 150 # Must match the input size used during training
IMG_HEIGHT = 150 # Must match the input size used during training
CLASS_NAMES = ['No Tumor', 'Tumor Detected']

# --- Model Loading (Cached for fast loading) ---
@st.cache_resource
def load_model(path):
    """Loads the pre-trained Keras/TensorFlow model."""
    try:
        model = tf.keras.models.load_model(path)
        return model
    except Exception as e:
        st.error(f"Error loading model: {e}")
        return None

model = load_model(MODEL_PATH)


# --- Prediction Function ---
def predict_image(image_data, model):
    """
    Preprocesses the uploaded image and makes a prediction.
    Steps must match training preprocessing (resize, normalize, expand dims).
    """
    # 1. Open and resize the image
    img = image_data.resize((IMG_WIDTH, IMG_HEIGHT))

    # 2. Convert to numpy array
    img_array = np.array(img)

    # 3. Add batch dimension (model expects shape [1, 150, 150, 3])
    img_array = np.expand_dims(img_array, axis=0)

    # 4. Normalize the image (if your training data was normalized by /255.0)
    # Assuming standard normalization was used:
    if np.max(img_array) > 1.0:
         img_array = img_array / 255.0

    # 5. Make prediction
    prediction = model.predict(img_array)

    # Get the predicted class index and probability
    predicted_class_index = np.argmax(prediction[0])
    confidence = prediction[0][predicted_class_index]

    return predicted_class_index, confidence


# --- Streamlit App Interface ---

st.set_page_config(page_title="Brain Tumor Detection", layout="centered")
st.title("ðŸ§  Brain Tumor Classification")
st.markdown("Upload an MRI brain scan image to detect the presence of a tumor.")

if model is None:
    st.warning("Model failed to load. Please ensure `brain_tumor_model.h5` is correctly uploaded.")
else:
    uploaded_file = st.file_uploader(
        "Choose a brain MRI image...",
        type=["jpg", "jpeg", "png"]
    )

    if uploaded_file is not None:
        # Display the uploaded image
        image = Image.open(uploaded_file)
        st.image(image, caption='Uploaded Image', use_column_width=True)
        st.markdown("---")

        # --- Run Prediction ---
        with st.spinner('Analyzing scan...'):
            # Pass the PIL Image object to the prediction function
            predicted_index, confidence = predict_image(image, model)
            predicted_label = CLASS_NAMES[predicted_index]


        # --- Display Results ---
        st.subheader("Prediction Result")

        if predicted_label == 'Tumor Detected':
            st.error(f"RESULT: {predicted_label}")
            st.metric("Confidence", f"{confidence:.2%}")
            st.warning("Seek medical advice immediately. This model indicates a tumor is likely present.")
        else:
            st.success(f"RESULT: {predicted_label}")
            st.metric("Confidence", f"{confidence:.2%}")
            st.info("The scan appears normal according to the model.")

        st.markdown("---")
        st.caption("Note: This is an AI tool and should not be used for actual diagnosis. Always consult a healthcare professional.")
